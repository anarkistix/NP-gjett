<!doctype html>
<html lang="no">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Nasjonalpark-spill</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
    <style>
      html, body { height: 100%; margin: 0; background:#fff; }
      body { font: 14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
      #map { position: absolute; inset: 0; }
      .hud { position:absolute; top:8px; left:8px; z-index:900; background:rgba(255,255,255,0.92); border:1px solid #ddd; border-radius:6px; padding:6px 8px; font-size:12px; }
      .topbar { position:absolute; top:8px; right:8px; z-index:900; display:flex; gap:6px; }
      .btn { background:#0a7a62; color:#fff; border:none; border-radius:6px; padding:8px 10px; font-size:14px; }
      .btn:active { transform: scale(0.98); }
      #hint { position:absolute; top:48px; left:8px; right:8px; z-index:900; display:flex; flex-direction:column; gap:6px; max-height:38vh; overflow:auto; }
      .hintItem { background:#111; color:#00ff88; border:2px solid #00ff88; border-radius:6px; padding:8px 10px; font: bold 13px monospace; letter-spacing:1px; text-shadow:0 0 2px #00ff88; }
      .scorebar { position:absolute; top:8px; right:8px; z-index:905; display:flex; gap:6px; }
      .score, .timer { background:#111; color:#00ff88; border:2px solid #00ff88; border-radius:6px; padding:6px 8px; font: bold 13px monospace; letter-spacing:1px; text-shadow:0 0 2px #00ff88; }
      #guessBar { position:absolute; bottom:0; left:0; right:0; z-index:900; background:rgba(255,255,255,0.98); border-top:1px solid #ddd; padding:10px 12px calc(10px + env(safe-area-inset-bottom)); }
      #choices { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
      .choiceBtn { background:#111; color:#00ff88; border:2px solid #00ff88; border-radius:6px; padding:10px 12px; font: bold 13px monospace; letter-spacing:1px; text-shadow:0 0 2px #00ff88; }
      .choiceBtn:active { transform: scale(0.98); }
      .choiceBtn.correct { background:#111; border-color:#00ff88; color:#00ff88; text-shadow:0 0 3px #00ff88; }
      .choiceBtn.wrong { background:#111; border-color:#ff6b6b; color:#ff6b6b; text-shadow:0 0 2px #ff6b6b; }
      .choiceBtn:disabled:not(.wrong):not(.correct), .choiceBtn.disabled:not(.wrong):not(.correct) { background:#e9e9e9; color:#9a9a9a; border-color:#c8c8c8; text-shadow:none; }
      .choiceBtn.wrong:disabled, .choiceBtn.wrong.disabled { background:#111; border-color:#ff6b6b; color:#ff6b6b; text-shadow:0 0 2px #ff6b6b; }
      #winOverlay { position:absolute; inset:0; z-index:1000; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); }
      .winContent { background:#111; border:2px solid #00ff88; border-radius:10px; padding:20px 24px; text-align:center; color:#00ff88; font: bold 28px monospace; letter-spacing:2px; text-shadow:0 0 3px #00ff88; }
      .winContent .btn { margin-top:12px; font-size:16px; }
      #correctOverlay { position:absolute; inset:0; z-index:1100; display:none; align-items:center; justify-content:center; pointer-events:none; }
      #correctOverlay .msg { background:#111; color:#00ff88; border:2px solid #00ff88; border-radius:10px; padding:16px 20px; font: bold 36px monospace; letter-spacing:2px; text-shadow:0 0 3px #00ff88; text-align:center; }
      #correctOverlay .msg .sub { margin-top:8px; font: bold 18px monospace; letter-spacing:1px; }
      #wrongOverlay { position:absolute; inset:0; z-index:1100; display:none; align-items:center; justify-content:center; pointer-events:none; }
      #wrongOverlay .msg { background:#111; color:#ff6b6b; border:2px solid #ff6b6b; border-radius:10px; padding:16px 20px; font: bold 36px monospace; letter-spacing:2px; text-shadow:0 0 3px #ff6b6b; }
      #endOverlay { position:absolute; inset:0; z-index:1200; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); }
      .endBox { background:#111; color:#00ff88; border:2px solid #00ff88; border-radius:10px; padding:20px 24px; width:min(500px, 92vw); max-height:90vh; text-align:center; box-shadow:0 0 12px rgba(0,0,0,0.5); overflow-y:auto; }
      .endBox h2 { margin:0 0 8px 0; font: bold 22px monospace; letter-spacing:1px; text-shadow:0 0 3px #00ff88; }
      .endScore { margin:6px 0 14px; font: bold 18px monospace; }
      .hsList { margin:8px 0; max-height:300px; overflow-y:auto; }
      .hsItem { display:flex; justify-content:space-between; padding:4px 8px; margin:2px 0; background:rgba(0,255,136,0.1); border:1px solid #00ff88; border-radius:4px; font: 12px monospace; }
      .hsName { color:#00ff88; }
      .hsScore { color:#00ff88; font-weight:bold; }
      .hsEntry { margin:8px 0; display:flex; gap:6px; align-items:center; }
      .hsEntry input { flex:1; padding:6px 8px; border:1px solid #00ff88; border-radius:4px; background:#111; color:#00ff88; font: 12px monospace; }
      .hsEntry button { padding:6px 10px; background:#00ff88; color:#111; border:none; border-radius:4px; font: 12px monospace; font-weight:bold; }
      .congratsMsg { margin:12px 0; padding:12px; background:rgba(0,255,136,0.15); border:2px solid #00ff88; border-radius:8px; text-align:center; }
      .congratsTitle { font: bold 16px monospace; color:#00ff88; margin-bottom:6px; text-shadow: 0 0 8px rgba(0,255,136,0.6); }
      .congratsText { font: 14px monospace; color:#00ff88; }
      .notQualifiedMsg { margin:12px 0; padding:12px; background:rgba(255,107,107,0.15); border:2px solid #ff6b6b; border-radius:8px; text-align:center; }
      .notQualifiedText { font: 14px monospace; color:#ff6b6b; }
      #splashOverlay { position:absolute; inset:0; z-index:1200; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); }
      .splashBox { background:#111; color:#00ff88; border:2px solid #00ff88; border-radius:10px; padding:18px 20px; width:min(520px, 90vw); box-shadow:0 0 12px rgba(0,0,0,0.5); }
      .splashTitle { font: bold 20px monospace; letter-spacing:1px; text-shadow:0 0 3px #00ff88; text-align:center; margin-bottom:10px; }
      .splashText { font: bold 14px monospace; letter-spacing:1px; text-shadow:0 0 2px #00ff88; margin-bottom:10px; }
      .splashList { margin:0 0 12px 18px; padding:0; }
      .splashList li { margin:6px 0; font: 13px monospace; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="hud" id="build">Build: ‚Ä¶</div>
    <div class="topbar">
      <button class="btn" id="nyRunde">Ny runde</button>
    </div>
    <div class="scorebar"><div class="timer" id="timer">TIME 00:00</div><div class="score" id="score">SCORE 01000</div></div>
    <div id="hint" style="display:none"></div>
    <div id="guessBar"><div id="choices"></div></div>
    <div id="winOverlay"><div class="winContent"><div>VINNER</div><button id="startNytt" class="btn">Start p√• nytt</button></div></div>
    <div id="correctOverlay"><div class="msg">KORREKT</div></div>
    <div id="wrongOverlay"><div class="msg">FEIL</div></div>
    <div id="endOverlay">
      <div class="endBox">
        <h2>Tiden er ute!</h2>
        <div class="endScore">Din score: <span id="endScoreVal">00000</span></div>
        <div id="congratsMsg" class="congratsMsg" style="display:none;">
          <div class="congratsTitle">üéâ GRATULERER! üéâ</div>
          <div class="congratsText">Du kom inn p√• topp 10-lista p√• <span id="congratsPosition">1.</span> plass!</div>
        </div>
        <div id="notQualifiedMsg" class="notQualifiedMsg" style="display:none;">
          <div class="notQualifiedText">Dessverre var ikke poengsummen din h√∏y nok for topp 10-lista. Pr√∏v igjen!</div>
        </div>
        <div class="hsTitle">Hi-score</div>
        <div id="hsList" class="hsList"></div>
        <div class="hsEntry" id="hsEntry">
          <input id="hsName" type="text" placeholder="Ditt navn" maxlength="24" />
          <button id="hsSave" class="choiceBtn">Lagre</button>
        </div>
        <div style="display:flex; justify-content:center; gap:10px;">
          <button id="endRestart" class="choiceBtn">START NYTT SPILL</button>
        </div>
      </div>
    </div>
    <div id="splashOverlay">
      <div class="splashBox">
        <div class="splashTitle">Det Store Nasjonalparkspillet</div>
        <div class="splashText">Hvor mange nasjonalparker klarer du √• gjette p√• to minutter?</div>
        <ul class="splashList">
          <li>Du f√•r poeng ut fra hvor mange fors√∏k du bruker.</li>
          <li>Du f√•r et nytt hint om parken for hvert fors√∏k du bruker.</li>
          <li>N√•r du har gjettet riktig g√•r vi videre til neste park.</li>
        </ul>
        
        <div style="display:flex; justify-content:center;">
          <button id="startGameBtn" class="choiceBtn">START NYTT SPILL</button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js" crossorigin="anonymous"></script>
    <script>
      (async () => {
        const map = L.map('map', { zoomControl: false, preferCanvas:true });
        const norwayStyle = { color:'#111', weight:1.2, fill:false };
        const parkStyle = { color:'#0a7a62', weight:1.0, fill:true, fillColor:'#cfeee1', fillOpacity:0.35 };
        const selectedStyle = { color:'#00ff88', weight:2, fill:true, fillColor:'#0a7a62', fillOpacity:0.5 };
        const norwayLayer = L.geoJSON(null, { style: norwayStyle }).addTo(map);
        const parksLayer = L.geoJSON(null, { style: parkStyle }).addTo(map);
        const focusLayer = L.geoJSON(null, { style: selectedStyle }).addTo(map);
        const hintEl = document.getElementById('hint');
        const scoreEl = document.getElementById('score');
        const winOverlay = document.getElementById('winOverlay');
        const startNyttBtn = document.getElementById('startNytt');
        const correctOverlay = document.getElementById('correctOverlay');
        const wrongOverlay = document.getElementById('wrongOverlay');
        const timerEl = document.getElementById('timer');
        const endOverlay = document.getElementById('endOverlay');
        const endScoreVal = document.getElementById('endScoreVal');
        const endRestartBtn = document.getElementById('endRestart');
        const hsListEl = document.getElementById('hsList');
        const hsEntryEl = document.getElementById('hsEntry');
        const hsNameEl = document.getElementById('hsName');
        const hsSaveBtn = document.getElementById('hsSave');
        const splashOverlay = document.getElementById('splashOverlay');
        const startGameBtn = document.getElementById('startGameBtn');

        // Build badge
        try {
          const b = await fetch('build_version.json?ts=' + Date.now());
          if (b.ok) { const v = await b.json(); const el = document.getElementById('build'); if (el && v && v.build) el.textContent = 'Build: ' + v.build; }
        } catch {}

        // Load outline and db
        const [gjRes, dbRes, hintsRes] = await Promise.all([
          fetch('norway_outline_full.json?ts=' + Date.now()),
          fetch('np_database.json?ts=' + Date.now()),
          fetch('park_hints.json?ts=' + Date.now())
        ]);
        if (!gjRes.ok) throw new Error('Klarte ikke √• hente norway_outline_full.json');
        if (!dbRes.ok) throw new Error('Klarte ikke √• hente np_database.json');
        const outline = await gjRes.json();
        const db = await dbRes.json();
        const hintsData = hintsRes.ok ? await hintsRes.json() : { parks: {} };
        // Score (retro)
        let score = 0;
        function renderScore(){
          try { scoreEl.textContent = 'SCORE ' + String(Math.max(0, Math.floor(score))).padStart(5, '0'); } catch {}
        }
        renderScore();
        
        // Hi-score system
        let highscores = [];
        
        // Park management system
        let shuffledParks = []; // Tilfeldig sortert liste over alle parker
        let usedParkIndices = new Set(); // Indekser til parker som allerede er brukt
        
        // Generer tilfeldig liste over alle nasjonalparker
        function generateShuffledParkList() {
          if (!merged.length) return;
          
          // Lag en kopi av merged arrayen
          shuffledParks = [...merged];
          
          // Fisher-Yates shuffle algoritme
          for (let i = shuffledParks.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledParks[i], shuffledParks[j]] = [shuffledParks[j], shuffledParks[i]];
          }
          
          // Reset brukte parker
          usedParkIndices.clear();
          
          console.log(`Genererte tilfeldig liste med ${shuffledParks.length} nasjonalparker`);
        }
        
        // Wake up Render server (asynkron i bakgrunnen)
        async function wakeUpRender(){
          try {
            console.log('Vekker opp Render server i bakgrunnen...');
            // Gj√∏r en enkel GET request for √• vekke opp Render-serveren
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 sekunder timeout for bakgrunn
            
            const response = await fetch('https://np-gjett-db.onrender.com/highscores?wakeup=' + Date.now(), {
              method: 'GET',
              signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
              console.log('‚úÖ Render server er v√•knet og klar!');
            } else {
              console.warn('‚ö†Ô∏è Render server svarte med status:', response.status);
            }
          } catch (e) {
            if (e.name === 'AbortError') {
              console.warn('‚è∞ Render server timeout - kan ta litt tid √• v√•kne opp');
            } else {
              console.warn('‚ùå Kunne ikke vekke opp Render server:', e.message);
            }
          }
        }
        
        async function loadHighscores(){
          try {
            const res = await fetch('https://np-gjett-db.onrender.com/highscores?ts=' + Date.now());
            if (res.ok) {
              highscores = await res.json();
            }
          } catch (e) {
            console.warn('Kunne ikke laste hi-scores:', e);
            highscores = [];
          }
        }
        
        
        function renderHighscores(targetEl){
          if (!targetEl) return;
          targetEl.innerHTML = '';
          highscores.forEach((hs, i) => {
            const div = document.createElement('div');
            div.className = 'hsItem';
            div.innerHTML = `<span class="hsName">${i+1}. ${hs.name}</span><span class="hsScore">${hs.score}</span>`;
            targetEl.appendChild(div);
          });
        }
        
        function qualifiesForHighscore(sc){
          return highscores.length < 10 || sc > (highscores[highscores.length-1]?.score || 0);
        }
        
        async function addHighscore(name, sc){
          if (!name || sc < 0) return false;
          
          // Send bare den nye scoren til backend
          try {
            const res = await fetch('https://np-gjett-db.onrender.com/highscores', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({name: name, score: sc})
            });
            
            if (res.ok) {
              // Oppdater lokal liste
              highscores.push({name: name, score: sc});
              highscores.sort((a,b) => b.score - a.score);
              highscores = highscores.slice(0, 10);
              
              // Oppdater UI
              renderHighscores(hsListEl);
              return true;
            }
          } catch (e) {
            console.warn('Kunne ikke lagre hi-score:', e);
          }
          return false;
        }
        
        // Timer (nedtelling 2:00)
        let countdownHandle = null; let countdownEndAtMs = 0; let gameOver = false;
        function formatTime(ms){ const t=Math.max(0, Math.floor(ms/1000)); const mm=String(Math.floor(t/60)).padStart(2,'0'); const ss=String(t%60).padStart(2,'0'); return mm+':'+ss; }
        function updateCountdown(){
          const remain = countdownEndAtMs - Date.now();
          if (timerEl) timerEl.textContent = 'TIME ' + formatTime(remain);
          if (remain <= 0){ stopCountdown(); endGame(); }
        }
        function startCountdown(totalMs){ stopCountdown(); countdownEndAtMs = Date.now() + totalMs; updateCountdown(); countdownHandle = setInterval(updateCountdown, 250); }
        function stopCountdown(){ if (countdownHandle) { clearInterval(countdownHandle); countdownHandle = null; } }
        let highscoreSaved = false; let lastFinalScore = 0;
        async function endGame(){
          if (gameOver) return; gameOver = true;
          const sc = Math.max(0, Math.floor(score));
          lastFinalScore = sc; highscoreSaved = false;
          if (endScoreVal) endScoreVal.textContent = String(sc).padStart(5,'0');
          
          // Oppdater hi-score listen
          renderHighscores(hsListEl);
          
          // Vis hi-score entry hvis spilleren kvalifiserer
          if (qualifiesForHighscore(sc)) {
            if (hsEntryEl) hsEntryEl.style.display = 'flex';
            if (hsNameEl) hsNameEl.focus();
            
            // Vis gratulasjon med plassering
            const congratsMsg = document.getElementById('congratsMsg');
            const congratsPosition = document.getElementById('congratsPosition');
            if (congratsMsg && congratsPosition) {
              // Finn plassering (hvor mange som har h√∏yere score)
              const position = highscores.filter(hs => hs.score > sc).length + 1;
              congratsPosition.textContent = position + '.';
              congratsMsg.style.display = 'block';
            }
            
            // Skjul "ikke kvalifisert" melding
            const notQualifiedMsg = document.getElementById('notQualifiedMsg');
            if (notQualifiedMsg) notQualifiedMsg.style.display = 'none';
          } else {
            if (hsEntryEl) hsEntryEl.style.display = 'none';
            
            // Skjul gratulasjon hvis ikke kvalifisert
            const congratsMsg = document.getElementById('congratsMsg');
            if (congratsMsg) congratsMsg.style.display = 'none';
            
            // Vis "ikke kvalifisert" melding
            const notQualifiedMsg = document.getElementById('notQualifiedMsg');
            if (notQualifiedMsg) notQualifiedMsg.style.display = 'block';
          }
          
          if (endOverlay) endOverlay.style.display = 'flex';
        }

        norwayLayer.addData(outline);
        try { map.fitBounds(norwayLayer.getBounds().pad(0.05)); } catch { map.setView([64.5, 16], 4); }

        const feats = (db && db.dataset && Array.isArray(db.dataset.features)) ? db.dataset.features : [];
        const parks = feats.filter(f => f && f.geometry && f.properties && f.properties.source==='park' && f.properties.status!=='deleted' && f.properties.display !== 'no');

        function normalizeKey(p) {
          const code = p && p.code; const name = p && p.name;
          return String(code || name || '').toLowerCase().replace(/[^a-z0-9√¶√∏√•]/g,'');
        }

        // Build merged features per park
        const groups = new Map();
        for (const f of parks) {
          const key = normalizeKey(f.properties);
          if (!groups.has(key)) groups.set(key, []);
          groups.get(key).push(f);
        }
        const merged = [];
        for (const [key, arr] of groups.entries()) {
          const polys = []; const rep = arr[0].properties || {};
          for (const g of arr) {
            const geom = g.geometry; if (!geom) continue;
            if (geom.type === 'Polygon') polys.push(geom.coordinates);
            else if (geom.type === 'MultiPolygon') polys.push(...geom.coordinates);
          }
          if (!polys.length) continue;
          const geom = polys.length===1 ? { type:'Polygon', coordinates: polys[0] } : { type:'MultiPolygon', coordinates: polys };
          merged.push({ type:'Feature', properties:{ name: rep.name, code: rep.code, key }, geometry: geom });
        }
        parksLayer.addData({ type:'FeatureCollection', features: merged });
        
        // Generer tilfeldig liste over nasjonalparker
        generateShuffledParkList();

        // Hjelpere for flervalg
        function cleanParkName(name){
          const s = String(name || '').trim();
          if (!s) return s;
          const slash = s.indexOf('/');
          if (slash > -1) return s.slice(0, slash).trim();
          return s;
        }
        function labelForPark(p){ const name = (p && p.name) || ''; return cleanParkName(name); }
        function shuffle(arr){ for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
        function pickOtherParks(excludeKey, count){
          const pool = merged.filter(f => f.properties && f.properties.key !== excludeKey);
          const out = [];
          const seen = new Set();
          while (out.length < Math.min(count, pool.length)){
            const cand = pool[Math.floor(Math.random()*pool.length)];
            const k = cand.properties && cand.properties.key;
            if (k && !seen.has(k)) { seen.add(k); out.push(cand); }
          }
          return out;
        }
        let wrongAttemptsInRound = 0;
        function renderChoicesForCurrent(){
          const container = document.getElementById('choices');
          if (!current || !container) return;
          const correctKey = current.properties.key;
          const opts = [current, ...pickOtherParks(correctKey, 5)].slice(0,6);
          const shuffled = shuffle(opts.slice());
          container.innerHTML = shuffled.map(p => `<button class="choiceBtn" data-key="${p.properties.key}">${labelForPark(p.properties)}</button>`).join('');
          container.querySelectorAll('.choiceBtn').forEach(btn => {
            btn.addEventListener('click', ()=>{
              if (gameOver) return;
              const k = btn.getAttribute('data-key');
              if (k === correctKey){
                btn.classList.add('correct');
                // Beregn poeng: 60 minus 10 per feilfors√∏k, min 10
                const gained = Math.max(10, 60 - 10*wrongAttemptsInRound);
                score += gained; renderScore();
                if (correctOverlay) {
                  const name = cleanParkName(current && current.properties && current.properties.name || '');
                  const box = correctOverlay.querySelector('.msg');
                  if (box) box.innerHTML = `KORREKT<div class="sub">${name}</div>`;
                  correctOverlay.style.display = 'flex';
                  setTimeout(()=>{ correctOverlay.style.display = 'none'; startRound(); }, 1000);
                } else {
                  setTimeout(()=>{ startRound(); }, 1000);
                }
              } else {
                btn.classList.add('wrong');
                btn.disabled = true; btn.classList.add('disabled');
                wrongAttemptsInRound += 1;
                if (wrongOverlay) {
                  wrongOverlay.style.display = 'flex';
                  setTimeout(()=>{
                    wrongOverlay.style.display = 'none';
                    if (hintIndex < currentHints.length-1) { hintIndex += 1; showHint(hintIndex); }
                  }, 1000);
                } else {
                  if (hintIndex < currentHints.length-1) { hintIndex += 1; showHint(hintIndex); }
                }
              }
            });
          });
        }

        function pickRandomPark() {
          if (!shuffledParks.length) return null;
          
          // Finn f√∏rste ubrukte park
          for (let i = 0; i < shuffledParks.length; i++) {
            if (!usedParkIndices.has(i)) {
              usedParkIndices.add(i);
              console.log(`Velger park ${i + 1}/${shuffledParks.length}: ${shuffledParks[i].name}`);
              return shuffledParks[i];
            }
          }
          
          // Hvis alle parker er brukt, start p√• nytt
          console.log('Alle parker er brukt, starter p√• nytt...');
          usedParkIndices.clear();
          if (shuffledParks.length > 0) {
            usedParkIndices.add(0);
            return shuffledParks[0];
          }
          
          return null;
        }

        function getHintsFor(p) {
          const parks = (hintsData && hintsData.parks) || {};
          const code = String((p && p.code) || '').trim();
          const name = String((p && p.name) || '').trim().toLowerCase();
          let entry = null;
          if (code) {
            for (const k of Object.keys(parks)) { const v = parks[k]; if (String(v && v.code || '').trim() === code) { entry = v; break; } }
          }
          if (!entry && name) {
            entry = parks[name] || null;
            if (!entry) {
              for (const k of Object.keys(parks)) { const v = parks[k]; const vn = String(v && v.name || '').trim().toLowerCase(); if (vn && vn === name) { entry = v; break; } }
            }
          }
          const list = (entry && Array.isArray(entry.hints)) ? entry.hints : [];
          return list;
        }

        function normalizeText(s) {
          try {
            return String(s || '')
              .toLowerCase()
              .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
              .replace(/[√¶√Ü]/g,'ae').replace(/[√∏√ò]/g,'o').replace(/[√•√Ö]/g,'a')
              .replace(/[^a-z0-9\(\)\-\s]/g,'')
              .trim();
          } catch { return String(s || '').toLowerCase().trim(); }
        }

        let current = null;
        let currentHints = [];
        let hintIndex = 0;
        let revealedHints = [];

        function showHint(idx){
          if (!currentHints.length) { hintEl.style.display='none'; hintEl.innerHTML=''; return; }
          const i = Math.min(idx, currentHints.length-1);
          revealedHints = currentHints.slice(0, i+1);
          // Siste hint √∏verst
          const items = revealedHints.slice().reverse().map((t, n) => `<div class="hintItem">${t}</div>`).join('');
          hintEl.innerHTML = items;
          hintEl.style.display = 'block';
        }

        async function startRound() {
          focusLayer.clearLayers();
          hintEl.style.display = 'none'; hintEl.innerHTML = '';
          revealedHints = [];
          if (winOverlay) winOverlay.style.display = 'none';
          if (correctOverlay) correctOverlay.style.display = 'none';
          if (wrongOverlay) wrongOverlay.style.display = 'none';
          if (splashOverlay) splashOverlay.style.display = 'none';
          wrongAttemptsInRound = 0;
          const park = pickRandomPark();
          if (!park) return;
          current = park;
          currentHints = getHintsFor(park.properties) || [];
          hintIndex = 0;
          focusLayer.addData(park);
          // Ikke start ny timer her ‚Äì nedtellingen gjelder hele spillet
          // Zoom s√• parken tar ca 50% av h√∏yden: bruk padding rundt bounds
          try {
            const b = focusLayer.getBounds();
            const padded = L.latLngBounds(
              [ b.getSouth() - (b.getNorth()-b.getSouth())*0.5, b.getWest() - (b.getEast()-b.getWest())*0.5 ],
              [ b.getNorth() + (b.getNorth()-b.getSouth())*0.5, b.getEast() + (b.getEast()-b.getWest())*0.5 ]
            );
            map.fitBounds(padded, { animate: true });
          } catch {}
          if (currentHints.length) { showHint(0); }
          // Bygg flervalg
          renderChoicesForCurrent();
        }

        document.getElementById('nyRunde').addEventListener('click', startRound);

        if (startNyttBtn) startNyttBtn.addEventListener('click', ()=>{
          winOverlay.style.display = 'none';
          startRound();
        });

        // Splash ved oppstart
        function showSplash(){ if (splashOverlay) splashOverlay.style.display = 'flex'; }
        if (startGameBtn) startGameBtn.addEventListener('click', ()=>{
          if (splashOverlay) splashOverlay.style.display = 'none';
          if (endOverlay) endOverlay.style.display = 'none';
          score = 0; renderScore(); gameOver = false;
          
          // Generer ny tilfeldig liste over nasjonalparker
          generateShuffledParkList();
          
          // Start spillet umiddelbart
          startCountdown(120000);
          startRound();
          
          // Vekk opp Render server i bakgrunnen (uten √• vente)
          wakeUpRender().catch(e => console.warn('Wake-up feilet:', e));
        });
        if (endRestartBtn) endRestartBtn.addEventListener('click', ()=>{
          if (endOverlay) endOverlay.style.display = 'none';
          showSplash();
        });
        
        // Hi-score event listeners
        if (hsSaveBtn) hsSaveBtn.addEventListener('click', async ()=>{
          const name = hsNameEl?.value?.trim();
          if (name && lastFinalScore >= 0) {
            const ok = await addHighscore(name, lastFinalScore);
            if (ok) {
              highscoreSaved = true;
              if (hsEntryEl) hsEntryEl.style.display = 'none';
            }
          }
        });
        
        if (hsNameEl) hsNameEl.addEventListener('keypress', (e)=>{
          if (e.key === 'Enter') {
            hsSaveBtn?.click();
          }
        });
        
        // Last hi-scores og vis splash umiddelbart
        await loadHighscores();
        renderHighscores(hsListEl);
        showSplash();
        
        // Vekk opp Render server i bakgrunnen (uten √• vente)
        wakeUpRender().catch(e => console.warn('Wake-up feilet:', e));
      })().catch(e => {
        const el = document.createElement('div');
        el.className = 'hud'; el.textContent = 'Feil: ' + (e && e.message || e);
        document.body.appendChild(el);
        console.error(e);
      });
    </script>
  </body>
  </html>


